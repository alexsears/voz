<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voz</title>
  <style>
:root {
  --bg: #070b16;
  --panel: #0c1226;
  --panel-2: #0a0f20;
  --surface: #111a33;
  --text: #e4e8f7;
  --muted: rgba(228, 232, 247, 0.55);
  --dim: rgba(228, 232, 247, 0.25);
  --accent: #7c5cff;
  --accent-glow: rgba(124, 92, 255, 0.35);
  --accent-2: #2fe6c5;
  --border: rgba(255, 255, 255, 0.06);
  --shadow: 0 12px 40px rgba(0,0,0,0.5);
  --radius: 14px;
  --transition: 220ms cubic-bezier(.2,.8,.2,1);
  --font: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, sans-serif;
  --mono: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', Consolas, monospace;
  --green: #34d399;
  --red: #f87171;
  --yellow: #fbbf24;
  --blue: #60a5fa;
  --terminal-bg: #050a14;
  --agent-w: 260px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body { background: var(--bg); color: var(--text); font-family: var(--font); }

/* ─── Onboarding (cloud mode) ─── */
.onboarding { position: fixed; inset: 0; z-index: 100; background: var(--bg); display: flex; align-items: center; justify-content: center; }
.onboarding.hidden { display: none; }
.onboarding__card { max-width: 440px; width: 100%; padding: 48px 36px; background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); text-align: center; }
.onboarding__orb { width: 72px; height: 72px; margin: 0 auto 24px; border-radius: 50%; background: radial-gradient(circle at 40% 35%, var(--accent), #1a0a40); box-shadow: 0 0 40px var(--accent-glow), 0 0 80px rgba(124,92,255,0.15); }
.onboarding h1 { font-size: 32px; font-weight: 800; margin-bottom: 8px; background: linear-gradient(135deg, #fff, var(--accent-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.onboarding p { color: var(--muted); font-size: 14px; line-height: 1.6; margin-bottom: 20px; }
.onboarding__input { display: flex; gap: 8px; }
.onboarding__input input { flex: 1; padding: 12px 16px; background: var(--terminal-bg); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-family: var(--mono); font-size: 13px; outline: none; }
.onboarding__input input:focus { border-color: var(--accent); }
.onboarding__input button { padding: 12px 24px; border: none; border-radius: 10px; background: linear-gradient(135deg, var(--accent), rgba(124,92,255,0.7)); color: white; font-weight: 700; font-size: 14px; cursor: pointer; }
.onboarding__err { color: var(--red); font-size: 12px; margin-top: 12px; min-height: 18px; }
.onboarding__hint { margin-top: 20px; font-size: 11px; color: var(--muted); opacity: 0.6; line-height: 1.5; }

/* ─── App shell ─── */
.app { display: flex; height: 100vh; }
.app.hidden { display: none; }

/* ─── Voz main area ─── */
.voz { flex: 1; display: flex; flex-direction: column; min-width: 0; }

/* hero bar */
.voz__hero {
  display: flex; align-items: center; gap: 16px;
  padding: 16px 24px;
  background: linear-gradient(180deg, rgba(124,92,255,0.06) 0%, transparent 100%);
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.voz__orb-wrap { position: relative; width: 44px; height: 44px; flex-shrink: 0; }
.voz__orb {
  width: 44px; height: 44px; border-radius: 50%;
  background: radial-gradient(circle at 38% 32%, var(--accent), #1a0a40 70%);
  box-shadow: 0 0 20px var(--accent-glow), 0 0 50px rgba(124,92,255,0.12);
  transition: all 0.6s ease;
}
.voz__orb-ring {
  position: absolute; inset: -4px; border-radius: 50%;
  border: 2px solid transparent;
  border-top-color: var(--accent);
  opacity: 0; transition: opacity 0.4s;
}
.voz--working .voz__orb { box-shadow: 0 0 30px rgba(251,191,36,0.35), 0 0 60px rgba(251,191,36,0.12); background: radial-gradient(circle at 38% 32%, var(--yellow), #2a1a00 70%); }
.voz--working .voz__orb-ring { opacity: 1; border-top-color: var(--yellow); animation: orb-spin 1.2s linear infinite; }
.voz--asking .voz__orb { box-shadow: 0 0 30px var(--accent-glow), 0 0 60px rgba(124,92,255,0.2); }
.voz--asking .voz__orb-ring { opacity: 1; animation: orb-pulse 2s ease infinite; }
@keyframes orb-spin { to { transform: rotate(360deg); } }
@keyframes orb-pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

.voz__identity { flex: 1; min-width: 0; }
.voz__name {
  font-size: 20px; font-weight: 800; letter-spacing: -0.3px;
  background: linear-gradient(135deg, #fff 30%, var(--accent-2));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.voz__status { font-size: 12px; color: var(--muted); margin-top: 1px; transition: color 0.3s; }
.voz--working .voz__status { color: var(--yellow); }
.voz--asking .voz__status { color: var(--accent); }

.voz__meta { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.voz__badge {
  font-size: 9px; font-weight: 700; padding: 3px 8px; border-radius: 5px;
  text-transform: uppercase; letter-spacing: 0.6px;
}
.voz__badge.local { background: rgba(52,211,153,0.12); color: var(--green); }
.voz__badge.cloud { background: rgba(124,92,255,0.12); color: var(--accent); }
.voz__voice-btn {
  width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--border);
  background: rgba(255,255,255,0.03); color: var(--muted); cursor: pointer;
  display: grid; place-items: center; font-size: 16px;
  transition: all var(--transition);
}
.voz__voice-btn:hover { background: rgba(124,92,255,0.12); color: var(--accent); border-color: var(--accent); }

/* terminal */
.voz__terminal {
  flex: 1; overflow-y: auto; padding: 12px 20px;
  background: var(--terminal-bg);
  font-family: var(--mono); font-size: 12.5px;
  line-height: 1.55; color: #94a3b8;
  white-space: pre-wrap; word-break: break-all;
}
.voz__terminal::-webkit-scrollbar { width: 5px; }
.voz__terminal::-webkit-scrollbar-thumb { background: rgba(124,92,255,0.2); border-radius: 3px; }
.voz__terminal .ln-prompt { color: var(--accent-2); }
.voz__terminal .ln-error { color: var(--red); }
.voz__terminal .ln-info { color: var(--blue); }

/* input */
.voz__input {
  padding: 12px 20px; border-top: 1px solid var(--border);
  background: rgba(0,0,0,0.15);
  display: flex; gap: 8px; align-items: flex-end; flex-shrink: 0;
}
.voz__input input {
  flex: 1; padding: 10px 16px;
  background: var(--terminal-bg); border: 1px solid var(--border);
  border-radius: 10px; color: var(--text);
  font-family: var(--mono); font-size: 13px;
  outline: none; height: 42px;
}
.voz__input input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124,92,255,0.1); }
.voz__input input::placeholder { color: var(--dim); }
.voz__input .send-btn {
  width: 42px; height: 42px; border: none; border-radius: 10px;
  background: linear-gradient(135deg, var(--accent), rgba(124,92,255,0.6));
  color: white; font-size: 16px; cursor: pointer;
  display: grid; place-items: center;
  transition: all var(--transition); flex-shrink: 0;
}
.voz__input .send-btn:hover { box-shadow: 0 4px 20px var(--accent-glow); transform: translateY(-1px); }

/* ─── Agent sidebar (right) ─── */
.agents {
  width: var(--agent-w); min-width: var(--agent-w); flex-shrink: 0;
  background: var(--panel);
  border-left: 1px solid var(--border);
  display: flex; flex-direction: column;
  overflow: hidden;
}
.agents__header {
  padding: 16px 16px 12px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 8px;
}
.agents__title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); flex: 1; }
.agents__count {
  font-size: 10px; font-weight: 700; color: var(--dim);
  background: rgba(255,255,255,0.04); padding: 2px 7px; border-radius: 4px;
}
.agents__list { flex: 1; overflow-y: auto; padding: 6px 8px; }
.agents__list::-webkit-scrollbar { width: 3px; }
.agents__list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 2px; }

/* agent card */
.agent {
  padding: 10px; border-radius: 10px; margin-bottom: 4px;
  cursor: pointer; transition: all var(--transition);
  border: 1px solid transparent;
  position: relative;
}
.agent:hover { background: rgba(255,255,255,0.03); }
.agent.expanded { background: rgba(124,92,255,0.08); border-color: var(--accent-glow); }
.agent__row { display: flex; align-items: center; gap: 8px; }
.agent__dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
  background: var(--dim);
}
.agent__dot.live { background: var(--green); box-shadow: 0 0 6px var(--green); }
.agent__dot.working { background: var(--yellow); box-shadow: 0 0 6px var(--yellow); animation: pulse-dot 1.5s infinite; }
.agent__dot.asking { background: var(--accent); box-shadow: 0 0 6px var(--accent); animation: pulse-dot 2s infinite; }
.agent__dot.stale { background: var(--dim); }
@keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
.agent__name { font-weight: 700; font-size: 12px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.agent__state-tag {
  font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px;
  text-transform: uppercase; letter-spacing: 0.3px;
  white-space: nowrap;
}
.agent__state-tag.ready { background: rgba(255,255,255,0.04); color: var(--dim); }
.agent__state-tag.idle { background: rgba(52,211,153,0.1); color: var(--green); }
.agent__state-tag.working { background: rgba(251,191,36,0.1); color: var(--yellow); }
.agent__state-tag.asking { background: rgba(124,92,255,0.12); color: var(--accent); }
.agent__state-tag.shell { background: rgba(248,113,113,0.1); color: var(--red); }
.agent__state-tag.unknown { background: rgba(255,255,255,0.04); color: var(--dim); }
.agent__preview {
  font-size: 10px; color: var(--muted); line-height: 1.35;
  margin-top: 6px; padding-left: 16px;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  overflow: hidden; word-break: break-word;
}

/* agent terminal drawer */
.agent__drawer {
  max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
  margin-top: 0;
}
.agent.expanded .agent__drawer { max-height: 200px; margin-top: 8px; }
.agent__term {
  background: var(--terminal-bg); border-radius: 6px;
  padding: 6px 8px; font-family: var(--mono); font-size: 10px;
  line-height: 1.4; color: #6b7a94; white-space: pre-wrap;
  word-break: break-all; max-height: 140px; overflow-y: auto;
}
.agent__term::-webkit-scrollbar { width: 2px; }
.agent__term::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); }
.agent__actions {
  display: flex; gap: 4px; margin-top: 4px;
}
.agent__actions button {
  flex: 1; padding: 4px; border: 1px solid var(--border); border-radius: 5px;
  background: transparent; color: var(--muted); font-size: 9px;
  font-family: var(--font); cursor: pointer; transition: all var(--transition);
}
.agent__actions button:hover { background: rgba(255,255,255,0.04); color: var(--text); }

/* add agent button */
.agents__add {
  margin: 4px 8px 8px; padding: 8px; border-radius: 8px;
  cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
  color: var(--dim); font-size: 11px; font-weight: 600;
  transition: all var(--transition);
  border: 1px dashed rgba(255,255,255,0.08);
}
.agents__add:hover { background: rgba(255,255,255,0.03); color: var(--muted); border-color: rgba(255,255,255,0.15); }

/* agents footer */
.agents__footer {
  padding: 8px 10px; border-top: 1px solid var(--border);
  display: flex; gap: 4px;
}
.agents__footer button {
  flex: 1; padding: 5px; border: 1px solid var(--border); border-radius: 5px;
  background: transparent; color: var(--dim); font-size: 9px; cursor: pointer;
  font-family: var(--font); transition: all var(--transition);
}
.agents__footer button:hover { background: rgba(255,255,255,0.03); color: var(--muted); }

/* tmux status */
.agents__tmux {
  padding: 6px 16px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 6px;
  font-size: 10px; color: var(--dim);
}
.agents__tmux.hidden { display: none; }
.agents__tmux-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.agents__tmux-dot.on { background: var(--green); box-shadow: 0 0 4px var(--green); }
.agents__tmux-dot.off { background: var(--red); }
.agents__tmux-text { flex: 1; }
.agents__tmux button {
  padding: 2px 6px; border: 1px solid var(--border); border-radius: 4px;
  background: transparent; color: var(--dim); font-size: 9px; cursor: pointer;
  font-family: var(--font);
}
.agents__tmux button:hover { color: var(--muted); }

/* ─── Modals ─── */
.modal-overlay { position: fixed; inset: 0; z-index: 50; background: rgba(0,0,0,0.7); backdrop-filter: blur(6px); display: flex; align-items: center; justify-content: center; }
.modal-overlay.hidden { display: none; }
.modal { width: 420px; padding: 28px; background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
.modal h3 { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
.modal label { display: block; font-size: 11px; font-weight: 600; color: var(--muted); margin-bottom: 6px; margin-top: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
.modal label:first-of-type { margin-top: 0; }
.modal input, .modal textarea { width: 100%; padding: 10px 14px; background: var(--terminal-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: var(--font); font-size: 13px; outline: none; }
.modal input:focus, .modal textarea:focus { border-color: var(--accent); }
.modal textarea { resize: vertical; min-height: 60px; }
.modal textarea.sysprompt { min-height: 100px; font-family: var(--mono); font-size: 12px; }
.modal__btns { display: flex; gap: 8px; margin-top: 20px; justify-content: flex-end; }
.modal__btns button { padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all var(--transition); font-family: var(--font); }
.modal__btns .cancel-btn { background: transparent; border: 1px solid var(--border); color: var(--muted); }
.modal__btns .create-btn { background: linear-gradient(135deg, var(--accent), rgba(124,92,255,0.7)); border: none; color: white; }

/* Toast */
.toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(80px); z-index: 200; padding: 10px 24px; border-radius: 10px; background: var(--surface); border: 1px solid var(--border); font-size: 13px; box-shadow: var(--shadow); opacity: 0; transition: all 300ms ease; white-space: nowrap; }
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
  </style>
</head>
<body>

<!-- Onboarding -->
<div class="onboarding hidden" id="onboarding">
  <div class="onboarding__card">
    <div class="onboarding__orb"></div>
    <h1>Voz</h1>
    <p>Your AI orchestrator. Enter your Anthropic API key to begin.</p>
    <div class="onboarding__input">
      <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-..." autocomplete="off" />
      <button id="apiKeySave">Connect</button>
    </div>
    <div class="onboarding__err" id="apiKeyErr"></div>
    <div class="onboarding__hint">Stored locally. <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--accent-2)">Get a key</a></div>
  </div>
</div>

<!-- App -->
<div class="app hidden" id="app">
  <!-- Voz main -->
  <div class="voz" id="vozMain">
    <div class="voz__hero">
      <div class="voz__orb-wrap">
        <div class="voz__orb" id="vozOrb"></div>
        <div class="voz__orb-ring" id="vozRing"></div>
      </div>
      <div class="voz__identity">
        <div class="voz__name">Voz</div>
        <div class="voz__status" id="vozStatus">Initializing...</div>
      </div>
      <div class="voz__meta">
        <div class="voz__badge" id="modeBadge"></div>
      </div>
    </div>
    <div class="voz__terminal" id="vozTerminal"><span style="color:var(--dim)">Connecting...</span></div>
    <div class="voz__input">
      <input type="text" id="vozInput" placeholder="Talk to Voz..." />
      <button class="send-btn" id="vozSend">&#9654;</button>
    </div>
  </div>

  <!-- Agents sidebar -->
  <aside class="agents">
    <div class="agents__header">
      <div class="agents__title">Agents</div>
      <div class="agents__count" id="agentCount">0</div>
    </div>
    <div class="agents__tmux hidden" id="tmuxBar">
      <div class="agents__tmux-dot off" id="tmuxDot"></div>
      <div class="agents__tmux-text" id="tmuxText">tmux</div>
      <button onclick="localStart()">Start</button>
      <button onclick="localStop()">Stop</button>
    </div>
    <div class="agents__list" id="agentList"></div>
    <div class="agents__add" id="addAgentBtn">
      <span>+</span> <span>New Agent</span>
    </div>
    <div class="agents__footer">
      <button id="settingsBtn">Settings</button>
    </div>
  </aside>
</div>

<!-- New agent modal -->
<div class="modal-overlay hidden" id="addModal">
  <div class="modal">
    <h3>New Agent</h3>
    <label>Name</label>
    <input type="text" id="newName" placeholder="my-project" />
    <label>Path (local mode)</label>
    <input type="text" id="newPath" placeholder="~/code/my-project" />
    <label>Description</label>
    <input type="text" id="newDesc" placeholder="REST backend service" />
    <label>System prompt (cloud, optional)</label>
    <textarea class="sysprompt" id="newSystem" placeholder="You are a senior backend engineer..."></textarea>
    <div class="modal__btns">
      <button class="cancel-btn" id="addCancel">Cancel</button>
      <button class="create-btn" id="addCreate">Create</button>
    </div>
  </div>
</div>

<!-- Settings modal -->
<div class="modal-overlay hidden" id="settingsModal">
  <div class="modal">
    <h3>Settings</h3>
    <label>Anthropic API Key</label>
    <input type="password" id="settingsKey" placeholder="sk-ant-api03-..." />
    <label>Default Model</label>
    <input type="text" id="settingsModel" placeholder="claude-sonnet-4-5-20250929" />
    <div class="modal__btns">
      <button class="cancel-btn" id="settingsCancel">Cancel</button>
      <button class="create-btn" id="settingsSave">Save</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ═══════════════════════════════════════════════════════
//  Voz — Jarvis-style orchestrator
// ═══════════════════════════════════════════════════════

const STATE_KEY = "voz_state";
const API_KEY_KEY = "voz_api_key";
const MODEL_KEY = "voz_model";
const DEFAULT_MODEL = "claude-sonnet-4-5-20250929";
const STALE_AFTER = 2;
const VOZ_ID = "local-voz";

let MODE = "cloud";
let LOCAL_API = "";
let state = loadState();
let prevOutputs = {};
let staleCounters = {};
let expandedAgent = null;

function loadState() {
  try { const r = localStorage.getItem(STATE_KEY); if (r) return JSON.parse(r); } catch {}
  return { sessions: [] };
}
function saveState() { localStorage.setItem(STATE_KEY, JSON.stringify(state)); }
function getApiKey() { return localStorage.getItem(API_KEY_KEY) || ""; }
function setApiKey(k) { localStorage.setItem(API_KEY_KEY, k); }
function getModel() { return localStorage.getItem(MODEL_KEY) || DEFAULT_MODEL; }
function setModel(m) { localStorage.setItem(MODEL_KEY, m || DEFAULT_MODEL); }

// ═══════════════════════════════════════════════════════
//  Claude state parser
// ═══════════════════════════════════════════════════════

function parseClaudeState(output) {
  if (!output || !output.trim()) return { state: "unknown", label: "No output", preview: "" };

  const lines = output.split("\n");
  const trimmed = lines.map(l => l.trim()).filter(l => l.length > 0);
  const last5 = trimmed.slice(-5).join("\n");
  const last8 = trimmed.slice(-8).join("\n");

  // Back at bash shell
  const lastLine = trimmed[trimmed.length - 1] || "";
  if (/\$\s*$/.test(lastLine) && /@/.test(lastLine)) {
    return { state: "shell", label: "Offline", preview: "Claude exited" };
  }

  // Fresh prompt — never interacted
  if (/Try \u201c/.test(last8) || /Try "/.test(last8)) {
    return { state: "ready", label: "Standing by", preview: "Awaiting instructions" };
  }

  // Permission prompt
  if (/Allow\?|Do you want to proceed|\(y\/n\)|\(Y\/n\)|yes\/no/i.test(last5)) {
    const q = trimmed.filter(l => /Allow\?|\?|proceed|confirm/i.test(l)).pop() || "";
    return { state: "asking", label: "Awaiting approval", preview: cleanPreview(q) || "Needs your confirmation" };
  }

  // AskUserQuestion prompt
  if (/\d+\.\s|Select|Choose|Which|pick/i.test(last5) && /\?\s*$/.test(last5)) {
    const questionLine = trimmed.filter(l => /\?/.test(l)).pop() || "";
    return { state: "asking", label: "Question for you", preview: cleanPreview(questionLine) };
  }

  // Working — tool execution
  const workPatterns = [
    /\u23f5\s+(Read|Edit|Write|Bash|Glob|Grep|Task)\b/,
    /\u29eb\s/, /^\s*\u280[0-9a-f]/, /Running\b.*\.\.\./,
    /Thinking\b/, /\u23f3/,
  ];
  for (const pat of workPatterns) {
    if (pat.test(last5)) {
      const workLine = trimmed.slice(-3).find(l => pat.test(l)) || lastLine;
      return { state: "working", label: "Working", preview: cleanPreview(workLine) };
    }
  }

  // Responding (no prompt at end)
  const hasPrompt = /^\u276f\s*$/.test(lastLine) || /^\u276f\s/.test(lastLine);
  if (!hasPrompt) {
    const recent = trimmed.slice(-6);
    if (recent.some(l => /^\s*\u23bf|^\s*\u2502|^\s*\u2514/.test(l))) {
      return { state: "working", label: "Responding", preview: cleanPreview(lastLine) };
    }
  }

  // Idle at prompt — extract last interaction
  if (hasPrompt || /\u276f/.test(last5)) {
    let lastUserMsg = "", lastClaudeMsg = "";
    for (let i = trimmed.length - 1; i >= 0; i--) {
      if (/^\u276f\s+\S/.test(trimmed[i]) && !lastUserMsg) lastUserMsg = trimmed[i].replace(/^\u276f\s+/, "");
      if (/^\u23bf\s/.test(trimmed[i]) && !lastClaudeMsg) lastClaudeMsg = trimmed[i].replace(/^\u23bf\s+/, "");
      if (lastUserMsg && lastClaudeMsg) break;
    }

    // Check if Claude's last block was a question
    const claudeLines = [];
    let inResp = false;
    for (let i = 0; i < trimmed.length; i++) {
      if (/^\u23bf/.test(trimmed[i])) { inResp = true; claudeLines.push(trimmed[i].replace(/^\u23bf\s*/, "")); }
      else if (/^\u276f/.test(trimmed[i])) { inResp = false; claudeLines.length = 0; }
      else if (inResp) claudeLines.push(trimmed[i]);
    }
    const block = claudeLines.join(" ").trim();
    const isQuestion = /\?\s*$/.test(block) || /\bwhat\b|\bwhich\b|\bshould\b|\bwould you\b|\bdo you\b/i.test(block.slice(-120));

    if (isQuestion && block) return { state: "asking", label: "Asked you", preview: cleanPreview(block.slice(-120)) };
    if (lastClaudeMsg) return { state: "idle", label: "Complete", preview: cleanPreview(lastClaudeMsg) };
    if (lastUserMsg) return { state: "idle", label: "Complete", preview: "You said: " + cleanPreview(lastUserMsg) };
    return { state: "idle", label: "Idle", preview: "Awaiting instructions" };
  }

  return { state: "unknown", label: "Active", preview: cleanPreview(lastLine) };
}

function cleanPreview(text) {
  return text
    .replace(/\x1b\[[0-9;]*m/g, "")
    .replace(/[\u23f5\u23bf\u276f\u29eb\u2502\u2514\u250c\u2500]/g, "")
    .replace(/\s+/g, " ").trim().slice(0, 140);
}

// ═══════════════════════════════════════════════════════
//  Staleness
// ═══════════════════════════════════════════════════════

function updateStaleness(s) {
  const out = (s.output || "").trim();
  if (prevOutputs[s.id] === undefined) { prevOutputs[s.id] = out; staleCounters[s.id] = 0; return; }
  if (prevOutputs[s.id] === out) staleCounters[s.id] = (staleCounters[s.id] || 0) + 1;
  else { staleCounters[s.id] = 0; prevOutputs[s.id] = out; }
}
function isStale(s) { return (staleCounters[s.id] || 0) >= STALE_AFTER; }

// ═══════════════════════════════════════════════════════
//  Init
// ═══════════════════════════════════════════════════════

async function detectMode() {
  // If served from the local dashboard, skip the health check
  if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
    LOCAL_API = location.origin;
    return "local";
  }
  try {
    const r = await fetch("http://localhost:4800/api/health", { signal: AbortSignal.timeout(1500) });
    const d = await r.json();
    if (d.ok) { LOCAL_API = "http://localhost:4800"; return "local"; }
  } catch {}
  return "cloud";
}

async function init() {
  MODE = await detectMode();
  const badge = document.getElementById("modeBadge");

  if (MODE === "local") {
    badge.textContent = "LOCAL"; badge.className = "voz__badge local";
    document.getElementById("onboarding").classList.add("hidden");
    document.getElementById("tmuxBar").classList.remove("hidden");
    document.getElementById("app").classList.remove("hidden");
    await localRefresh();
    renderAll();
    setInterval(localRefresh, 4000);
  } else {
    badge.textContent = "CLOUD"; badge.className = "voz__badge cloud";
    document.getElementById("tmuxBar").classList.add("hidden");
    document.getElementById("newPath").closest("label")?.style && (document.getElementById("newPath").previousElementSibling.style.display = "none");
    document.getElementById("newPath").style.display = "none";
    if (getApiKey()) {
      document.getElementById("app").classList.remove("hidden");
      renderAll();
    } else {
      document.getElementById("onboarding").classList.remove("hidden");
    }
  }
}

// ═══════════════════════════════════════════════════════
//  Local mode
// ═══════════════════════════════════════════════════════

async function localApi(path, opts = {}) {
  try {
    const r = await fetch(LOCAL_API + path, { headers: { "Content-Type": "application/json" }, ...opts });
    return await r.json();
  } catch (e) { return { error: e.message }; }
}

async function localRefresh() {
  const data = await localApi("/api/status");
  const dot = document.getElementById("tmuxDot");
  const text = document.getElementById("tmuxText");

  if (data.session) { dot.className = "agents__tmux-dot on"; text.textContent = "Running"; }
  else { dot.className = "agents__tmux-dot off"; text.textContent = "Stopped"; }

  if (data.projects) {
    for (const lp of data.projects) {
      const sid = "local-" + lp.name;
      const existing = state.sessions.find(s => s.id === sid);
      if (!existing) {
        state.sessions.push({
          id: sid, name: lp.name, desc: lp.description || "",
          local: true, status: lp.active ? "live" : "idle",
          output: lp.output || "",
        });
      } else {
        existing.status = lp.active ? "live" : "idle";
        existing.output = lp.output || existing.output || "";
        existing.desc = lp.description || existing.desc;
      }
      updateStaleness(state.sessions.find(s => s.id === sid));
    }
    const localNames = new Set(data.projects.map(p => "local-" + p.name));
    state.sessions = state.sessions.filter(s => !s.local || localNames.has(s.id));
    saveState();
  }
  renderAll();
}

async function localDispatch(name, message) {
  const realName = name.replace("local-", "");
  const r = await localApi(`/api/project/${realName}/dispatch`, {
    method: "POST", body: JSON.stringify({ message }),
  });
  if (r.ok) { toast("Sent to " + realName); setTimeout(localRefresh, 2000); }
  else toast("Error: " + (r.error || "failed"));
}

async function localStopProject(name) {
  const realName = name.replace("local-", "");
  await localApi(`/api/project/${realName}/stop`, { method: "POST" });
  toast("Ctrl-C sent to " + realName);
  setTimeout(localRefresh, 1000);
}

async function localStart() {
  document.getElementById("tmuxDot").className = "agents__tmux-dot on";
  document.getElementById("tmuxText").textContent = "Starting...";
  toast("Starting all sessions...");
  await localApi("/api/start", { method: "POST" });
  setTimeout(localRefresh, 3000);
}

async function localStop() {
  document.getElementById("tmuxDot").className = "agents__tmux-dot off";
  document.getElementById("tmuxText").textContent = "Stopping...";
  toast("Stopping...");
  await localApi("/api/stop", { method: "POST" });
  setTimeout(localRefresh, 3000);
}

function colorize(text) {
  return text.split("\n").map(line => {
    if (/error|Error|ERROR|fail|FAIL/i.test(line)) return `<span class="ln-error">${esc(line)}</span>`;
    if (/^(>>|\$|\u276f)/.test(line.trim())) return `<span class="ln-prompt">${esc(line)}</span>`;
    if (/info|complete|success|done/i.test(line)) return `<span class="ln-info">${esc(line)}</span>`;
    return esc(line);
  }).join("\n");
}

// ═══════════════════════════════════════════════════════
//  Cloud mode
// ═══════════════════════════════════════════════════════

function createSession(name, desc, systemPrompt) {
  return { id: crypto.randomUUID(), name: name || "untitled", desc: desc || "",
    systemPrompt: systemPrompt || "", messages: [], status: "idle",
    createdAt: Date.now(), lastActiveAt: Date.now() };
}

async function callClaude(apiKey, messages, systemPrompt, stream = false) {
  const body = { model: getModel(), max_tokens: 8192, messages, stream };
  if (systemPrompt) body.system = systemPrompt;
  const res = await fetch("/api/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json", "x-api-key": apiKey },
    body: JSON.stringify(body),
  });
  return stream ? res : res.json();
}

// ═══════════════════════════════════════════════════════
//  Render
// ═══════════════════════════════════════════════════════

function renderAll() {
  renderVoz();
  renderAgents();
}

function renderVoz() {
  const voz = state.sessions.find(s => s.id === VOZ_ID);
  const main = document.getElementById("vozMain");
  const statusEl = document.getElementById("vozStatus");
  const termEl = document.getElementById("vozTerminal");

  if (!voz) {
    statusEl.textContent = "No session detected";
    main.className = "voz";
    return;
  }

  const cs = parseClaudeState(voz.output);
  voz._parsed = cs;

  // Update orb state
  main.className = "voz" +
    (cs.state === "working" ? " voz--working" : "") +
    (cs.state === "asking" ? " voz--asking" : "");

  // Status text
  const agentSummary = getAgentSummary();
  if (cs.state === "working") {
    statusEl.textContent = cs.preview ? "Working \u2014 " + cs.preview : "Working...";
  } else if (cs.state === "asking") {
    statusEl.textContent = cs.preview ? cs.label + ": " + cs.preview : cs.label;
  } else if (cs.state === "ready") {
    statusEl.textContent = agentSummary ? "Standing by \u2014 " + agentSummary : "Standing by. Ready for your command.";
  } else if (cs.state === "idle") {
    statusEl.textContent = cs.preview ? cs.preview : (agentSummary || "Ready.");
  } else {
    statusEl.textContent = cs.label || "Active";
  }

  // Terminal — in-place update
  if (voz.output) {
    const atBottom = termEl.scrollTop + termEl.clientHeight >= termEl.scrollHeight - 30;
    termEl.innerHTML = colorize(voz.output);
    if (atBottom) termEl.scrollTop = termEl.scrollHeight;
  }
}

function getAgentSummary() {
  const agents = state.sessions.filter(s => s.id !== VOZ_ID);
  if (agents.length === 0) return "";
  const working = agents.filter(s => (s._parsed || parseClaudeState(s.output)).state === "working");
  const asking = agents.filter(s => (s._parsed || parseClaudeState(s.output)).state === "asking");
  const parts = [];
  if (working.length) parts.push(working.map(s => s.name).join(", ") + " working");
  if (asking.length) parts.push(asking.map(s => s.name).join(", ") + " needs you");
  return parts.join(" \u2022 ");
}

function renderAgents() {
  const list = document.getElementById("agentList");
  const countEl = document.getElementById("agentCount");
  const agents = state.sessions.filter(s => s.id !== VOZ_ID);

  countEl.textContent = agents.length;

  // Preserve scroll
  const scrollTop = list.scrollTop;
  list.innerHTML = "";

  agents.forEach(s => {
    const cs = parseClaudeState(s.output);
    s._parsed = cs;

    const dotState = cs.state === "working" ? "working" : cs.state === "asking" ? "asking" :
      (s.local && isStale(s)) ? "stale" : s.status === "live" ? "live" : "stale";

    const card = document.createElement("div");
    card.className = "agent" + (expandedAgent === s.id ? " expanded" : "");
    card.innerHTML = `
      <div class="agent__row">
        <div class="agent__dot ${dotState}"></div>
        <div class="agent__name">${esc(s.name)}</div>
        <div class="agent__state-tag ${cs.state}">${esc(cs.label)}</div>
      </div>
      ${cs.preview ? `<div class="agent__preview">${esc(cs.preview)}</div>` : ""}
      <div class="agent__drawer">
        <div class="agent__term" id="aterm-${s.id}">${s.output ? miniTerminal(s.output) : '<span style="opacity:0.3">No output</span>'}</div>
        <div class="agent__actions">
          <button onclick="agentSend('${s.id}')">Send message</button>
          <button onclick="localStopProject('${s.id}')">Ctrl-C</button>
        </div>
      </div>
    `;
    card.querySelector(".agent__row").onclick = () => {
      expandedAgent = expandedAgent === s.id ? null : s.id;
      renderAgents();
    };
    list.appendChild(card);
  });

  list.scrollTop = scrollTop;
}

function miniTerminal(output) {
  // Last 12 lines, compact
  const lines = output.split("\n").slice(-12);
  return lines.map(l => esc(l)).join("\n");
}

function agentSend(sid) {
  const msg = prompt("Message for " + sid.replace("local-", "") + ":");
  if (msg && msg.trim()) localDispatch(sid, msg.trim());
}

// ═══════════════════════════════════════════════════════
//  Voz input
// ═══════════════════════════════════════════════════════

function setupVozInput() {
  const input = document.getElementById("vozInput");
  const btn = document.getElementById("vozSend");
  const doSend = () => {
    const msg = input.value.trim();
    if (!msg) return;
    input.value = "";
    if (MODE === "local") {
      localDispatch(VOZ_ID, msg);
    }
    // Cloud mode Voz chat could go here
  };
  btn.onclick = doSend;
  input.onkeydown = (e) => { if (e.key === "Enter") doSend(); };
}
setupVozInput();

// ═══════════════════════════════════════════════════════
//  New agent
// ═══════════════════════════════════════════════════════

document.getElementById("addAgentBtn").onclick = () => {
  document.getElementById("addModal").classList.remove("hidden");
  document.getElementById("newName").value = "";
  document.getElementById("newPath").value = "";
  document.getElementById("newDesc").value = "";
  document.getElementById("newSystem").value = "";
  setTimeout(() => document.getElementById("newName").focus(), 100);
};
document.getElementById("addCancel").onclick = () => document.getElementById("addModal").classList.add("hidden");
document.getElementById("addCreate").onclick = () => {
  const name = document.getElementById("newName").value.trim();
  if (!name) { document.getElementById("newName").focus(); return; }
  const desc = document.getElementById("newDesc").value.trim();
  const path = document.getElementById("newPath").value.trim();
  const sys = document.getElementById("newSystem").value.trim();
  if (MODE === "local" && path) {
    toast("Local agent creation coming soon");
    document.getElementById("addModal").classList.add("hidden");
    return;
  }
  const s = createSession(name, desc, sys);
  state.sessions.push(s); saveState();
  document.getElementById("addModal").classList.add("hidden");
  renderAll();
  toast("Agent '" + name + "' created");
};
document.getElementById("newName").onkeydown = (e) => { if (e.key === "Enter") document.getElementById("addCreate").click(); };

// ═══════════════════════════════════════════════════════
//  Onboarding / Settings / Modals
// ═══════════════════════════════════════════════════════

document.getElementById("apiKeySave").onclick = async () => {
  const key = document.getElementById("apiKeyInput").value.trim();
  const err = document.getElementById("apiKeyErr");
  if (!key) { err.textContent = "Enter an API key."; return; }
  err.textContent = "Validating...";
  try {
    const r = await callClaude(key, [{ role: "user", content: "Say hi" }], null, false);
    if (r.error) { err.textContent = "Invalid: " + (typeof r.error === "string" ? r.error : JSON.stringify(r.error)); return; }
    setApiKey(key);
    document.getElementById("onboarding").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    renderAll(); toast("Connected.");
  } catch (e) { err.textContent = "Error: " + e.message; }
};
document.getElementById("apiKeyInput").onkeydown = (e) => { if (e.key === "Enter") document.getElementById("apiKeySave").click(); };

document.getElementById("settingsBtn").onclick = () => {
  document.getElementById("settingsKey").value = getApiKey();
  document.getElementById("settingsModel").value = getModel();
  document.getElementById("settingsModal").classList.remove("hidden");
};
document.getElementById("settingsCancel").onclick = () => document.getElementById("settingsModal").classList.add("hidden");
document.getElementById("settingsSave").onclick = () => {
  const k = document.getElementById("settingsKey").value.trim();
  const m = document.getElementById("settingsModel").value.trim();
  if (k) setApiKey(k); if (m) setModel(m);
  document.getElementById("settingsModal").classList.add("hidden");
  toast("Settings saved");
};

document.onkeydown = (e) => {
  if (e.key === "Escape") {
    document.getElementById("addModal").classList.add("hidden");
    document.getElementById("settingsModal").classList.add("hidden");
  }
};
document.getElementById("addModal").onclick = (e) => { if (e.target.id === "addModal") e.target.classList.add("hidden"); };
document.getElementById("settingsModal").onclick = (e) => { if (e.target.id === "settingsModal") e.target.classList.add("hidden"); };

// ═══════════════════════════════════════════════════════
//  Helpers
// ═══════════════════════════════════════════════════════

function esc(s) { const d = document.createElement("div"); d.textContent = s; return d.innerHTML; }
function toast(msg) { const t = document.getElementById("toast"); t.textContent = msg; t.classList.add("show"); setTimeout(() => t.classList.remove("show"), 3000); }

// ═══════════════════════════════════════════════════════
//  Boot
// ═══════════════════════════════════════════════════════

init();
</script>
</body>
</html>
